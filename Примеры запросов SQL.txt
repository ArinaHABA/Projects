№1
SELECT table_1.country, 
total_invoice, 
total_customer
FROM (SELECT billing_country AS country,
     COUNT(invoice_id) AS total_invoice
FROM invoice
WHERe EXTRACT(year from CAST(invoice_date as date)) =
      (SELECT EXTRACT(year from CAST(invoice_date as date)) AS year_1
FROM invoice
WHERe EXTRACT(month from CAST(invoice_date as date)) IN (6,7,8)
GROUP BY year_1
ORDER BY SUM(total) DESC
LIMIt 1) GROUP BY country) AS table_1
LEFT JOIN (SELECT country, COUNT(customer_id) AS total_customer
FROM client
GROUP BY country) AS table_2
ON table_1.country = table_2.country
ORDER BY total_invoice DESC, table_1.country;


№2
WITH
year_2012 AS (SELECT EXTRACT(month FROM CAST(invoice_date AS date)) as Month,
      SUM(total) AS sum_total_2012
FROM invoice
WHERE EXTRACT(year FROM CAST(invoice_date AS date)) = '2012'
     GROUP BY month),
year_2013 AS (SELECT EXTRACT(month FROM CAST(invoice_date AS date)) as Month,
      SUM(total) AS sum_total_2013
FROM invoice
WHERE EXTRACT(year FROM CAST(invoice_date AS date)) = '2013'
     GROUP BY month)

SELECT year_2012.Month,
year_2012.sum_total_2012, year_2013.sum_total_2013,
ROUND((year_2013.sum_total_2013 - year_2012.sum_total_2012)*100/year_2012.sum_total_2012) AS perc
FROM year_2012 LEFT JOIN year_2013 ON year_2012.Month=year_2013.Month
ORDER BY Month;


№3
SELECT billing_country
FROM
(SELECT billing_country, EXTRACT(month from CAST(invoice_date as date)), AVG(total) AVGG
FROM invoice
WHERE EXTRACT(year from CAST(invoice_date as date)) = '2009'
GROUP BY billing_country, EXTRACT(month from CAST(invoice_date as date)), billing_country) AS More
WHERE date_part IN (2,5,7,10)
GROUP BY billing_country
HAVING SUM(AVGG) > 10;


№4
select client_id,
	   case 
	   	when "action" like '%visit%'
	   	then hitdatetime 
	   	else null
	   	end as visit_dt,
	   case
	   	when "action" like '%registration%'
	   	then 1
	   	else 0
	   end as is_registration
	   from user_activity_log
limit 10;


№5 
SELECT client_id, cast(date_trunc('Month', hitdatetime) as date) as month,
COUNT(CASE WHEN action = 'login' THEN 1 END) visit_to_login_events 
FROM
  (SELECT client_id,
          hitdatetime,
          action,
          lag(hitdatetime) OVER (PARTITION BY client_id
                                 ORDER BY hitdatetime) prev_hitdatetime
   FROM user_activity_log)t
GROUP BY client_id, CAST(DATE_TRUNC('Month', hitdatetime) as date);
